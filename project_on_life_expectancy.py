# -*- coding: utf-8 -*-
"""Project on Life Expectancy.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1sJvITZ3cIdde6KflXxqGMz0EFC_l_kec

**1. Data Cleaning**
"""

import pandas as pd
import numpy as np

RAW_CSV_URL = "https://raw.githubusercontent.com/Lekitsherin1999/Mental-Health-/main/health_indicators_btn2025.csv"

df_raw = pd.read_csv(RAW_CSV_URL)

print(df_raw.shape)
df_raw.head()

df = df_raw[df_raw['GHO (CODE)'] != '#indicator+code'].copy()


df = df[df['COUNTRY (CODE)'] == 'BTN'].copy()

df_life = df[df['GHO (CODE)'] == 'WHOSIS_000001'].copy()

print(df_life['GHO (DISPLAY)'].unique())
print(df_life['DIMENSION (NAME)'].unique())
df_life.head()

cols_to_keep = [
    'YEAR (DISPLAY)',
    'COUNTRY (DISPLAY)',
    'DIMENSION (NAME)',
    'Numeric',
    'Low',
    'High'
]

df_life = df_life[cols_to_keep].copy()


df_life = df_life.rename(columns={
    'YEAR (DISPLAY)': 'year',
    'COUNTRY (DISPLAY)': 'country',
    'DIMENSION (NAME)': 'sex',
    'Numeric': 'life_expectancy',
    'Low': 'ci_low',
    'High': 'ci_high'
})


for col in ['life_expectancy', 'ci_low', 'ci_high']:
    df_life[col] = pd.to_numeric(df_life[col], errors='coerce')


df_life['year'] = pd.to_numeric(df_life['year'], errors='coerce').astype('Int64')


df_life = df_life.dropna(subset=['life_expectancy']).copy()


df_life = df_life.sort_values(['year', 'sex']).reset_index(drop=True)

df_life.head(10)

print("Shape:", df_life.shape)
print(df_life['sex'].value_counts())
print(df_life['year'].min(), "→", df_life['year'].max())

df_life.describe()

df_life.to_csv("life_expectancy_btn_clean.csv", index=False)

from google.colab import files
files.download("life_expectancy_btn_clean.csv")

"""**2. EDA**"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# Paste your RAW URL here
CSV_URL = "https://raw.githubusercontent.com/Lekitsherin1999/Mental-Health-/main/Data/life_expectancy_btn_clean.csv"

df = pd.read_csv(CSV_URL)
df.head()

plt.figure(figsize=(10,5))
sns.lineplot(data=df, x='year', y='life_expectancy', marker='o')
plt.title("Life Expectancy in Bhutan 2000-2021")
plt.ylabel("Life Expectancy (years)")
plt.grid(True)
plt.show()

plt.figure(figsize=(10,5))
sns.lineplot(data=df, x='year', y='life_expectancy', hue='sex', marker='o')
plt.title("Life Expectancy in Bhutan by Sex")
plt.ylabel("Life Expectancy (years)")
plt.grid(True)
plt.show()

plt.figure(figsize=(10,5))

for sex in df['sex'].unique():
    subset = df[df['sex'] == sex]
    plt.plot(subset['year'], subset['life_expectancy'], marker='o', label=f"{sex} (Estimate)")
    plt.fill_between(subset['year'], subset['ci_low'], subset['ci_high'], alpha=0.2)

plt.title("Life Expectancy with Confidence Intervals")
plt.ylabel("Life Expectancy (years)")
plt.legend()
plt.grid(True)
plt.show()

print("Year Range:", df['year'].min(), "→", df['year'].max())
print("\nLife Expectancy Stats:")
print(df['life_expectancy'].describe())

print("\nSex Breakdown:")
print(df['sex'].value_counts())

"""**3. Features Engineering**"""

import pandas as pd
import numpy as np

CSV_URL = "https://raw.githubusercontent.com/Lekitsherin1999/Mental-Health-/main/Data/life_expectancy_btn_clean.csv"

df = pd.read_csv(CSV_URL)
df.head()

# 1. Years since 2000 (time index)
df['years_since_2000'] = df['year'] - 2000

# 2. One-hot style flags for sex
df['is_female'] = (df['sex'] == 'Female').astype(int)
df['is_male']   = (df['sex'] == 'Male').astype(int)
# Both sexes will have 0 for both flags → baseline category

# 3. Confidence interval span
df['ci_span'] = df['ci_high'] - df['ci_low']

# 4. 3-year moving average of life expectancy within each sex
df = df.sort_values(['sex', 'year']).reset_index(drop=True)
df['life_expectancy_3yr_ma'] = (
    df.groupby('sex')['life_expectancy']
      .transform(lambda s: s.rolling(window=3, min_periods=1).mean())
)

df.head(10)

print("Columns after feature engineering:")
print(df.columns.tolist())

print("\nSummary of numeric columns:")
print(df.describe())

output_path = "life_expectancy_btn_features.csv"
df.to_csv(output_path, index=False)
output_path

from google.colab import files
files.download("life_expectancy_btn_features.csv")

"""**4. Modelling**"""

import pandas as pd
import numpy as np

from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_squared_error, r2_score

import joblib

# Paste your RAW file URL here
CSV_URL = "https://raw.githubusercontent.com/Lekitsherin1999/Mental-Health-/main/Data/life_expectancy_btn_features.csv"

df = pd.read_csv(CSV_URL)
df.head()

#life_expectancy
# Target
y = df['life_expectancy']

# Feature columns — all except target, country, sex (sex is already encoded)
feature_cols = [
    'year',
    'years_since_2000',
    'is_female',
    'is_male',
    'ci_low',
    'ci_high',
    'ci_span',
    'life_expectancy_3yr_ma'
]

X = df[feature_cols]

X.head()

#train/test split
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

X_train.shape, X_test.shape

#Train Regression Model
model = RandomForestRegressor(
    n_estimators=300,
    random_state=42
)

model.fit(X_train, y_train)

# Predict
y_pred = model.predict(X_test)

mse = mean_squared_error(y_test, y_pred)
rmse = np.sqrt(mse) # Calculate RMSE by taking the square root of MSE
r2 = r2_score(y_test, y_pred)

print("RMSE:", rmse)
print("R²:", r2)

#comparison
results = pd.DataFrame({
    'Actual': y_test.values,
    'Predicted': y_pred
})
results

joblib.dump(model, "model.pkl")

from google.colab import files
files.download("model.pkl")